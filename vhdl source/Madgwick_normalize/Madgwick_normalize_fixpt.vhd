-- -------------------------------------------------------------
-- 

-- File Name: C:\Users\z68j959\Documents\GitHub\EELE466\hdl_coder_Madgwick_normalize\codegen\Madgwick_normalize\hdlsrc\Madgwick_normalize_fixpt.vhd
-- Created: 2015-03-31 13:25:51
-- 
-- Generated by MATLAB 8.3, MATLAB Coder 2.6 and HDL Coder 3.4
-- 
-- 
-- 
-- -------------------------------------------------------------
-- Rate and Clocking Details
-- -------------------------------------------------------------
-- Design base rate: 1
-- 
-- 
-- Clock Enable  Sample Time
-- -------------------------------------------------------------
-- ceout         1
-- -------------------------------------------------------------
-- 
-- 
-- Output Signal                 Clock Enable  Sample Time
-- -------------------------------------------------------------
-- ax                            ceout         1
-- ay                            ceout         1
-- az                            ceout         1
-- aw                            ceout         1
-- -------------------------------------------------------------
-- 
-- -------------------------------------------------------------


-- -------------------------------------------------------------
-- 
-- Module: Madgwick_normalize_fixpt
-- Source Path: Madgwick_normalize_fixpt
-- Hierarchy Level: 0
-- 
-- -------------------------------------------------------------
LIBRARY IEEE;
USE IEEE.std_logic_1164.ALL;
USE IEEE.numeric_std.ALL;

ENTITY Madgwick_normalize_fixpt IS
  PORT( clk                               :   IN    std_logic;
        reset                             :   IN    std_logic;
        clkenable                         :   IN    std_logic;
        ax1                               :   IN    std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        ay1                               :   IN    std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        az1                               :   IN    std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        aw1                               :   IN    std_logic;  -- ufix1
        ceout                             :   OUT   std_logic;
        ax                                :   OUT   std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        ay                                :   OUT   std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        az                                :   OUT   std_logic_vector(13 DOWNTO 0);  -- sfix14_En9
        aw                                :   OUT   std_logic  -- ufix1
        );
END Madgwick_normalize_fixpt;


ARCHITECTURE rtl OF Madgwick_normalize_fixpt IS

  -- Constants
  CONSTANT One                            : unsigned(1 DOWNTO 0) := to_unsigned(2#10#, 2);  -- ufix2
  CONSTANT C_divbyzero_p                  : unsigned(1 DOWNTO 0) := to_unsigned(2#11#, 2);  -- ufix2

  -- Signals
  SIGNAL enb                              : std_logic;
  SIGNAL aw_1                             : std_logic;  -- ufix1
  SIGNAL ax1_signed                       : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL ax_1                             : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL ay1_signed                       : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL ay_1                             : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL az1_signed                       : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL az_1                             : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL aw_1_1                           : std_logic;  -- ufix1
  SIGNAL ax_tmp                           : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL ay_tmp                           : signed(13 DOWNTO 0);  -- sfix14_En9
  SIGNAL az_tmp                           : signed(13 DOWNTO 0);  -- sfix14_En9

BEGIN
  aw_1 <= aw1;

  ax1_signed <= signed(ax1);

  enb <= clkenable;

  in_0_pipe_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      ax_1 <= to_signed(2#00000000000000#, 14);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        ax_1 <= ax1_signed;
      END IF;
    END IF;
  END PROCESS in_0_pipe_process;


  ay1_signed <= signed(ay1);

  in_1_pipe_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      ay_1 <= to_signed(2#00000000000000#, 14);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        ay_1 <= ay1_signed;
      END IF;
    END IF;
  END PROCESS in_1_pipe_process;


  az1_signed <= signed(az1);

  in_2_pipe_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      az_1 <= to_signed(2#00000000000000#, 14);
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        az_1 <= az1_signed;
      END IF;
    END IF;
  END PROCESS in_2_pipe_process;


  in_3_pipe_process : PROCESS (clk, reset)
  BEGIN
    IF reset = '1' THEN
      aw_1_1 <= '0';
    ELSIF clk'EVENT AND clk = '1' THEN
      IF enb = '1' THEN
        aw_1_1 <= aw_1;
      END IF;
    END IF;
  END PROCESS in_3_pipe_process;


  Madgwick_normalize_fixpt_1_output : PROCESS (ax_1, ay_1, az_1, aw_1_1)
    VARIABLE dotproduct : unsigned(13 DOWNTO 0);
    VARIABLE mul_temp : signed(27 DOWNTO 0);
    VARIABLE add_cast : signed(28 DOWNTO 0);
    VARIABLE mul_temp_0 : signed(27 DOWNTO 0);
    VARIABLE add_cast_0 : signed(28 DOWNTO 0);
    VARIABLE add_temp : signed(28 DOWNTO 0);
    VARIABLE add_cast_1 : signed(29 DOWNTO 0);
    VARIABLE mul_temp_1 : signed(27 DOWNTO 0);
    VARIABLE add_cast_2 : signed(29 DOWNTO 0);
    VARIABLE add_temp_0 : signed(29 DOWNTO 0);
    VARIABLE add_cast_3 : signed(30 DOWNTO 0);
    VARIABLE t_0 : std_logic;
    VARIABLE add_cast_4 : unsigned(1 DOWNTO 0);
    VARIABLE add_cast_5 : signed(30 DOWNTO 0);
    VARIABLE add_temp_1 : signed(30 DOWNTO 0);
    VARIABLE cast : unsigned(13 DOWNTO 0);
    VARIABLE cast_0 : signed(14 DOWNTO 0);
    VARIABLE mul_temp_2 : signed(28 DOWNTO 0);
    VARIABLE cast_1 : signed(27 DOWNTO 0);
    VARIABLE cast_2 : unsigned(13 DOWNTO 0);
    VARIABLE cast_3 : signed(14 DOWNTO 0);
    VARIABLE mul_temp_3 : signed(28 DOWNTO 0);
    VARIABLE cast_4 : signed(27 DOWNTO 0);
    VARIABLE cast_5 : unsigned(13 DOWNTO 0);
    VARIABLE cast_6 : signed(14 DOWNTO 0);
    VARIABLE mul_temp_4 : signed(28 DOWNTO 0);
    VARIABLE cast_7 : signed(27 DOWNTO 0);
    VARIABLE cast_8 : unsigned(13 DOWNTO 0);
    VARIABLE t_1 : unsigned(13 DOWNTO 0);
    VARIABLE cast_9 : unsigned(14 DOWNTO 0);
  BEGIN
    --HDL code generation from MATLAB function: Madgwick_normalize_fixpt
    --'Madgwick_normalize_fixpt:22' aw = fi(aw*recipNorm, 0, 1, 0, fm);
    --'Madgwick_normalize_fixpt:21' az = fi(az*recipNorm, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:20' ay = fi(ay*recipNorm, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:19' ax = fi(ax*recipNorm, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:33' c = fi( c1, numerictype( c1 ), fimath( a ) );
    --'Madgwick_normalize_fixpt:32' c1 = divide( divideType( a1, b1 ), a1, b1 );
    --'Madgwick_normalize_fixpt:31' b1 = fi( b, 'RoundMode', 'fix' );
    --'Madgwick_normalize_fixpt:30' a1 = fi( a, 'RoundMode', 'fix' );
    --'Madgwick_normalize_fixpt:29' if isfi( a ) && isfi( b )
    --'Madgwick_normalize_fixpt:28' coder.inline( 'always' );
    
--'Madgwick_normalize_fixpt:18' recipNorm = fi(fi_div(fi(1, 0, 1, 0, fm), sqrt( dotproduct )), 0, 14, 14, fm);
    --%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    --                                                                          %
    --       Generated by MATLAB 8.3, MATLAB Coder 2.6 and HDL Coder 3.4        %
    --                                                                          %
    --%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
    
--'Madgwick_normalize_fixpt:9' fm = fimath('RoundingMethod', 'Floor', 'OverflowAction', 'Wrap', 'ProductMode', 'FullPrecision', 'MaxProductWordLength', 128, 'SumMode', 'FullPrecision', 'MaxSumWordLength', 128);
    --'Madgwick_normalize_fixpt:11' aw = fi(aw_1, 0, 1, 0, fm);
    --'Madgwick_normalize_fixpt:12' ax = fi(ax_1, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:13' ay = fi(ay_1, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:14' az = fi(az_1, 1, 14, 9, fm);
    --'Madgwick_normalize_fixpt:16' dotproduct = fi(ax*ax + ay*ay + az*az + aw*aw, 0, 14, 4, fm);
    mul_temp := ax_1 * ax_1;
    add_cast := resize(mul_temp, 29);
    mul_temp_0 := ay_1 * ay_1;
    add_cast_0 := resize(mul_temp_0, 29);
    add_temp := add_cast + add_cast_0;
    add_cast_1 := resize(add_temp, 30);
    mul_temp_1 := az_1 * az_1;
    add_cast_2 := resize(mul_temp_1, 30);
    add_temp_0 := add_cast_1 + add_cast_2;
    add_cast_3 := resize(add_temp_0, 31);
    IF aw_1_1 = '1' THEN 
      t_0 := aw_1_1;
    ELSE 
      t_0 := '0';
    END IF;
    add_cast_4 := '0' & t_0;
    add_cast_5 := signed(resize(add_cast_4 & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' & '0' 
      & '0' & '0' & '0' & '0' & '0' & '0' & '0', 31));
    add_temp_1 := add_cast_3 + add_cast_5;
    dotproduct := unsigned(add_temp_1(27 DOWNTO 14));
    --'Madgwick_normalize_fixpt:17' if dotproduct~=fi(0, 0, 1, 0, fm)
    IF dotproduct /= 0 THEN 
      cast := to_unsigned(2#00000000000000#, 14);
      cast_0 := signed(resize(cast, 15));
      mul_temp_2 := ax_1 * cast_0;
      cast_1 := mul_temp_2(27 DOWNTO 0);
      ax_tmp <= cast_1(27 DOWNTO 14);
    ELSE 
      ax_tmp <= ax_1;
    END IF;
    IF dotproduct /= 0 THEN 
      cast_2 := to_unsigned(2#00000000000000#, 14);
      cast_3 := signed(resize(cast_2, 15));
      mul_temp_3 := ay_1 * cast_3;
      cast_4 := mul_temp_3(27 DOWNTO 0);
      ay_tmp <= cast_4(27 DOWNTO 14);
    ELSE 
      ay_tmp <= ay_1;
    END IF;
    IF dotproduct /= 0 THEN 
      cast_5 := to_unsigned(2#00000000000000#, 14);
      cast_6 := signed(resize(cast_5, 15));
      mul_temp_4 := az_1 * cast_6;
      cast_7 := mul_temp_4(27 DOWNTO 0);
      az_tmp <= cast_7(27 DOWNTO 14);
    ELSE 
      az_tmp <= az_1;
    END IF;
    IF dotproduct /= 0 THEN 
      cast_8 := to_unsigned(2#00000000000000#, 14);
      IF aw_1_1 = '1' THEN 
        t_1 := cast_8;
      ELSE 
        t_1 := to_unsigned(2#00000000000000#, 14);
      END IF;
      cast_9 := resize(t_1, 15);
      aw <= cast_9(14);
    ELSE 
      aw <= aw_1_1;
    END IF;
  END PROCESS Madgwick_normalize_fixpt_1_output;


  ax <= std_logic_vector(ax_tmp);

  ay <= std_logic_vector(ay_tmp);

  az <= std_logic_vector(az_tmp);

  ceout <= clkenable;

END rtl;

